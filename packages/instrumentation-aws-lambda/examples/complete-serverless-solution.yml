# COMPLETE SERVERLESS SOLUTION WITH ESM AUTO-PATCH BANNER
#
# This shows exactly how to add ESM auto-patching to your existing serverless.yml
# The banner automatically handles ESM Lambda handler instrumentation.

service: your-service-name
provider:
  name: aws
  deploymentMethod: direct
  region: ${opt:region, 'us-east-1'}
  runtime: nodejs20.x
  timeout: 30
  environment:
    NODE_ENV: ${env:NODE_ENV}
  logRetentionInDays: 14

custom:
  esbuild:
    sourcemap: true
    bundle: true
    minify: false
    exclude:
      - pg-native
    format: 'esm'
    platform: 'node'
    target: 'esnext'
    outputFileExtension: '.mjs'

    # üéØ ADD THIS BANNER TO YOUR EXISTING esbuild CONFIGURATION
    # This banner automatically patches ESM handlers with OpenTelemetry
    banner:
      js: |
        import { createRequire } from 'module';
        const require = createRequire(import.meta.url);
        import { fileURLToPath as ssb_fileURLToPath } from 'url';
        import { dirname as ssb_dirname } from 'path';

        // Define CommonJS globals for ESM compatibility
        const _filename = ssb_fileURLToPath(import.meta.url);
        const _dirname = ssb_dirname(_filename);

        // Make __dirname and __filename available globally for packages that expect them
        if (typeof globalThis !== 'undefined') {
          globalThis.__dirname = _dirname;
          globalThis.__filename = _filename;
        }

        // ESM Auto-Patch Banner - Provides helper function for manual patching
        // Since ESM exports are immutable, we provide a patcher function you can use
        if (globalThis.__aws_lambda_esm_instrumentation) {
          console.log('üîß OpenTelemetry instrumentation detected, setting up ESM patching helper...');

          // Create a global patcher function that can be called in your handler file
          globalThis.__patchESMHandler = (handlerFunction, handlerName = 'handler') => {
            if (typeof handlerFunction === 'function') {
              try {
                const patchedHandler = globalThis.__aws_lambda_esm_instrumentation.patchESMHandler(handlerFunction, handlerName);
                console.log('‚úÖ ESM handler patched with OpenTelemetry');
                return patchedHandler;
              } catch (error) {
                console.error('‚ùå Failed to patch ESM handler:', error.message);
                return handlerFunction; // Return original if patching fails
              }
            }
            console.warn('‚ö†Ô∏è Handler is not a function, skipping OpenTelemetry patching');
            return handlerFunction;
          };
        }
