FROM public.ecr.aws/lambda/nodejs:20

# Set working directory first
WORKDIR ${LAMBDA_TASK_ROOT}

# Copy package.json first for better Docker caching
COPY package.json ${LAMBDA_TASK_ROOT}/

# Install dependencies (use --omit=dev instead of deprecated --production, --insecure to bypass SSL issues in Docker)
# --omit=dev installs packages listed in dependencies section of package.json (required for runtime)
# skips devDependencies and other optional packages
# --insecure bypasses SSL issues in Docker this is okay for local development
RUN npm install --omit=dev --insecure

# Copy Lambda handler and instrumentation files
COPY handler.mjs ${LAMBDA_TASK_ROOT}/
COPY init-otel-custom.cjs ${LAMBDA_TASK_ROOT}/
COPY custom-instrumentation-compiled.cjs ${LAMBDA_TASK_ROOT}/
COPY otel-handler-custom ${LAMBDA_TASK_ROOT}/

# Make wrapper executable
RUN chmod +x ${LAMBDA_TASK_ROOT}/otel-handler-custom

# Set the CMD to your handler (this will be overridden by docker-compose command)
CMD [ "handler.handler" ]

